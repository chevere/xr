<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>XR Session</title>
    <link rel="stylesheet" media="all" href="style.css">
    <link rel="alternate icon" type="image/png" href="icon.png">
    <link rel="icon" href="icon.svg">
    <link rel="apple-touch-icon" href="icon.svg">
    <link rel="mask-icon" href="icon.svg" color="#000">
</head>
<body>
    <header>
        <div contenteditable="true" class="header-title">XR Session</div>
        <div class="header-filter">
            <span class="topic user-select-none cursor-pointer hide-if-empty"></span><span class="emote user-select-none cursor-pointer hide-if-empty"></span>
        </div>
    </header>
    <template id="message">
        <div class="message" data-emote="" data-topic="">
            <div class="status">
                <div class="time">%time%</div>
            </div>
            <div class="body">
                <div><span class="topic user-select-none cursor-pointer hide-if-empty">%topic%</span><span class="emote user-select-none cursor-pointer hide-if-empty">%emote%</span></div>
                <div class="body-raw hide-if-empty">%message%</div>
                <div class="body-file">
                    <span class="body-file-display hide-if-empty user-select-none" title="%fileDisplay%">%fileDisplayShort%</span>
                </div>
            </div>
        </div>
    </template>
</body>
<script>
    var filter = {
        topic: '',
        emote: '',
    },
    filterOperator = {
        topic: '=',
        emote: '*=',
    },
    filterCSSIndex,
    styleEl = document.createElement('style');
    es = new EventSource('dump');
    document.head.appendChild(styleEl);
    es.addEventListener('message', function (event) {
        var data = JSON.parse(event.data),
        template = document.querySelector('#message'),
        el = template.content.cloneNode(true);
        el.querySelector('.time').textContent = (new Date()).toTimeString().split(' ')[0];
        el.querySelector('.topic').textContent = data.topic;
        el.querySelector('.emote').textContent = data.emote;
        el.querySelector('.body-raw').innerHTML = data.message;
        var bodyFileDisplay = el.querySelector('.body-file-display');
        bodyFileDisplay.textContent = data.file_display_short;
        bodyFileDisplay.setAttribute('title', data.file_display);
        document.body.prepend(el);
        el = document.querySelector('.message');
        el.dataset.emote = data.emote;
        el.dataset.topic = data.topic;
    });
    document.querySelector('.header-title').addEventListener('input', event => {
        document.title = event.target.textContent;
    });
    document.addEventListener('click', event => {
        var el = event.target;
        if (el.classList.contains('body-file-display')) {
            navigator.clipboard.writeText(el.getAttribute('title'));
        }
        if(el.classList.contains('topic') || el.classList.contains('emote')) {
            var filterQuery = '',
                hasFilter = false,
                message = el.closest('.message'),
                header = el.closest('header'),
                resetFilter = header !== null,
                subject = el.classList.contains('topic')
                    ? 'topic'
                    : 'emote';
            if(message && filter[subject]  === message.dataset[subject]) {
                return;
            }
            filter[subject] = message
                ? message.dataset[subject]
                : '';
            for(filterSubject in filter) {
                if(filter[filterSubject] === '') {
                    continue;
                }
                resetFilter = false;
                filterQuery += '[data-' +  filterSubject + filterOperator[filterSubject] + '"' + filter[filterSubject] + '"]';
            }
            if(typeof filterCSSIndex === 'number') {
                styleEl.sheet.removeRule(filterCSSIndex);
            }
            filterCSSIndex = filterQuery === ''
                ? null
                : filterCSSIndex = styleEl.sheet
                    .insertRule('.message:not(' + filterQuery + ') { display: none; }');
            document.querySelector('.header-filter .' + subject).textContent = message
                ? filter[subject]
                : '';
        }
    });
    </script>
</html>
